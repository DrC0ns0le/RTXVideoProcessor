# RTXVideoProcessor

A high-performance CLI tool that applies **NVIDIA RTX Video Super Resolution (VSR)** and **TrueHDR** processing to H.264/H.265 videos using the NVIDIA RTX Video SDK. Can be used as a **drop-in FFmpeg replacement** with RTX acceleration.

## Features

- üöÄ **RTX Acceleration**: GPU-accelerated Video Super Resolution (2√ó upscaling) and SDR-to-HDR tone mapping
- üéØ **Drop-in FFmpeg Replacement**: FFmpeg syntax support with automatic passthrough for unsupported operations
- üì∫ **HLS Streaming**: Native HLS output with fMP4 or MPEGTS segments
- üåê **Network Streaming**: Supports HTTP/HTTPS/RTMP/RTSP/TCP/UDP input streams
- üîÑ **Zero-copy Pipeline**: GPU processing without CPU roundtrips for maximum performance
- üé¨ **Stream Mapping**: Full FFmpeg `-map` syntax for precise stream control
- üéµ **Audio Passthrough**: All audio/subtitle streams copied verbatim or transcoded as needed
- ‚ö° **Fast Processing**: ~2-5√ó real-time speed on RTX 4070 (preset-dependent)
- üé® **HDR Metadata**: Automatic BT.2020/PQ mastering data injection for TrueHDR output
- üì¶ **Flexible Formats**: MP4, MKV, HLS input/output with pipe and fragmented MP4 support

For detailed information about RTX Video SDK capabilities, see [NVIDIA RTX Video SDK Documentation](https://developer.nvidia.com/rtx-video-sdk).

## Performance

Based on RTX 4070 testing:
- **p7 preset**: ~2√ó real-time for 1080p input
- **p4 preset**: ~3-5√ó real-time for 1080p input *(note: occasional stutters reported)*

**Project Status**: ‚ö†Ô∏è **Alpha - Not Production Ready**

This tool is currently in **alpha stage** and provided **as-is without warranty**. While functional as an MVP, further refinement is needed for production use.

**FFmpeg Compatibility**: This is **not a full FFmpeg replacement**. Only a subset of FFmpeg features have been implemented. Tested primarily with Jellyfin and Stremio; other use cases may require additional features.

**Word of caution**: This is my first attempt at a C++ project. I am not a professional developer and I am not a C++ developer. This project is as much of a learning experience for me as it is a tool for me. I have never touched C++, CUDA or system programming prior to this project. Majority of the code is generated by AI tools, however, I have --- to my best of knowledge and ability --- attempted to understand and refine the code, ensuring it is as close to production-ready as possible. Contributions and feedback are greatly appreciated, especially from those with FFmpeg/CUDA expertise!

## Documentation

For detailed technical documentation about the complete end-to-end pipeline architecture, operating modes, and FFmpeg compatibility behavior, see [docs/PIPELINE_ARCHITECTURE.md](docs/PIPELINE_ARCHITECTURE.md).

**Note**: Documentation may contain slight inaccuracies as the codebase evolves. If you notice discrepancies between documentation and actual behavior, please open an issue.

## Operating Modes

RTXVideoProcessor supports **three operating modes** that are automatically detected based on command-line syntax:

### 1. Simple Mode (Default)
- **Syntax**: `RTXVideoProcessor.exe input.mp4 output.mp4 [options]`
- **Use case**: Quick video enhancement with RTX processing
- **Auto-detected**: When no `-i` flag is present (positional input/output arguments)
- **Features**: RTX VSR + TrueHDR enabled by default, simplified syntax

### 2. FFmpeg-Compatible Mode
- **Syntax**: `RTXVideoProcessor.exe -i input.mp4 [options] output.mp4`
- **Use case**: Drop-in FFmpeg replacement with RTX processing
- **Auto-detected**: When `-i` flag is present in arguments
- **Features**: FFmpeg syntax support (`-i`, `-map`, `-codec`, `-ss`, etc.) + RTX processing
- **Behavior**: Strict FFmpeg compliance (no auto-corrections, reports timestamp violations)

### 3. FFmpeg Passthrough Mode
- **Trigger**: Binary renamed to `ffmpeg.exe` AND (unsupported format OR `-map -0:v?` video exclusion)
- **Use case**: Automatic delegation to real FFmpeg for unsupported operations
- **Features**: Seamless fallback to system FFmpeg for audio-only, unsupported formats, etc.

**How Passthrough Works**:
1. Binary is renamed to `ffmpeg.exe`
2. Tool detects if operation is supported (MP4/MKV video processing with RTX)
3. **Supported**: Processes with RTX acceleration
4. **Unsupported**: Automatically delegates to real `ffmpeg.exe` in system PATH
5. Returns exit code and output from whichever process handled the request

**Passthrough Triggers**:
- Audio-only operations (no video stream)
- Unsupported input formats (`.avi`, `.mov`, `.wmv`, etc.)
- Unsupported output formats (anything other than `.mp4`, `.mkv`, `.m3u8`)
- Video exclusion via `-map -0:v` or `-map -0:v?`

**Note**: Both Simple Mode and FFmpeg-Compatible Mode support full RTX processing (VSR + TrueHDR). The difference is only in argument syntax and strict FFmpeg behavior compliance.

## Processing Paths
- **GPU path (default)** Requires NVDEC/NVENC. Color conversion, RTX evaluation, and packing run on the CUDA context supplied by FFmpeg. 
- **CPU path (`--cpu`)** Forces software color conversion and host-side RTX processing while NVENC still produces Main10 output from CPU-backed P010 frames.


## Command-line Options

### Common Options (Both Modes)

**Processing Control**
- **`-v`, `--verbose`**: Enable verbose logging
- **`--cpu`**: Force CPU processing path (software color conversion)
- **`--no-vsr`**: Disable RTX VSR upscaling
- **`--vsr-quality <1-4>`**: VSR quality level (default 4)
- **`--no-thdr`**: Disable RTX TrueHDR tone mapping
- **`--thdr-contrast <int>`**: TrueHDR contrast (default 115)
- **`--thdr-saturation <int>`**: TrueHDR saturation (default 75)
- **`--thdr-middle-gray <int>`**: TrueHDR middle gray (default 30)
- **`--thdr-max-luminance <int>`**: TrueHDR peak luminance in nits (default 1000)

**Encoder Settings**
- **`--nvenc-tune <string>`**: NVENC tune (default `hq`)
- **`--nvenc-preset <string>`**: NVENC preset (default `p7`)
- **`--nvenc-rc <string>`**: NVENC rate control mode (default `constqp`)
- **`--nvenc-gop <int>`**: GOP length in seconds as `gop * fps` (default 3)
- **`--nvenc-bframes <int>`**: Maximum B-frame count (default 2)
- **`--nvenc-qp <int>`**: Constant QP (default 21 when `constqp` is active)
- **`--nvenc-bitrate-multiplier <int>`**: Bitrate multiplier (default 5√ó, fallback 25 Mbps)
 - **`-r <fps>`, `-r:v <fps>`**: Override output framerate
   - Works with `-vsync cfr` to produce a constant frame rate timeline
   - Encoder timebase is chosen to yield exact ticks-per-frame for CFR when possible; otherwise an integer timescale is used

### FFmpeg-Compatible Mode Only

**Input/Output**
- **`-i <input>`**: Specify input file (required in FFmpeg mode)
  - Supports local files (`.mp4`, `.mkv`)
  - Supports network streams (`http://`, `https://`, `rtmp://`, `rtsp://`, `tcp://`, `udp://`)
  - Supports pipe input (`pipe:0` or `-`)
- **Output**: Specify output file or destination
  - Local files (`.mp4`, `.mkv`, `.m3u8`)
  - Pipe output (`pipe:1`, `pipe:`, or `-`)
- **`-f <format>`**: Force input/output format
- **`-y`**: Overwrite output files without asking

**Stream Mapping**
- **`-map <stream_spec>`**: Select streams to include (e.g., `-map 0:0 -map 0:1`)
  - Explicit mapping only includes specified streams
  - Use `-map -0:s` to exclude subtitle streams
- **`-codec:a <codec>`** or **`-c:a <codec>`**: Audio codec (use `copy` for passthrough)
- **`-ac <channels>`**: Audio channels
- **`-ab <bitrate>`**: Audio bitrate
- **`-ar <rate>`**: Audio sample rate
- **`-af <filter>`**: Audio filter chain

**Input/Demuxer Options**
- **`-fflags <flags>`**: Format flags for input demuxer (e.g., `+genpts` to generate missing PTS)
  - Must be specified before `-i` in FFmpeg-compatible mode
  - Common flags: `+genpts` (generate presentation timestamps), `+igndts` (ignore DTS)

**Seeking & Timestamps**
- **`-ss <time>`**: Seek to position (before `-i` for input seek, after for output seek)
- **`-t <duration>`**: Limit output duration
- **`-copyts`**: Preserve original timestamps from input
- **`-start_at_zero`**: Force output timestamps to start at zero
- **`-avoid_negative_ts <mode>`**: Handle negative timestamps (`auto`/`make_zero`/`make_non_negative`/`disabled`)
- **`-output_ts_offset <time>`**: Add offset to output timestamps
  - Note: For HLS output, this offset is intentionally not applied to the segment muxer; HLS segments start near zero for better `baseMediaDecodeTime` and player compatibility.
- **`-noaccurate_seek`**: Discard frames before seek target (default behavior when seeking with `-ss`)
- **`-seek2any <0|1>`**: Allow seeking to non-keyframes at demuxer level (may cause artifacts until next keyframe)
  - Enables `AVSEEK_FLAG_ANY` for faster but less accurate seeking
  - Can produce garbled output until the next keyframe is decoded
- **`-seek_timestamp <0|1>`**: Enable/disable seeking by timestamp with `-ss`
  - When disabled (default, `0`): adds stream `start_time` to seek position (FFmpeg default behavior)
  - When enabled (`1`): seeks to absolute timestamp without adjustment
  - FFmpeg compatibility option for streams with non-zero start times
- **`-vsync <mode>`**: Video synchronization mode
  - `cfr`: Constant frame rate - generates evenly spaced timestamps
  - Useful for fixing variable frame rate issues or ensuring consistent playback timing

**HLS Streaming**
- **`-format hls`**: Enable HLS output (output must be `.m3u8`)
- **`-hls_time <seconds>`**: Segment duration in seconds (default 2)
- **`-hls_segment_type <type>`**: Segment type (`mpegts` or `fmp4`)
- **`-hls_fmp4_init_filename <file>`**: fMP4 initialization file name
- **`-hls_segment_filename <pattern>`**: Segment filename pattern (default: auto-generated with `.m4s` for fMP4, `.ts` for MPEGTS)
- **`-hls_playlist_type <type>`**: Playlist type (`event` or `vod`)
- **`-hls_list_size <count>`**: Maximum number of playlist entries (0 = all)
- **`-start_number <num>`**: Start segment numbering from this value

**Muxer Options**
- **`-movflags <flags>`**: MP4 muxer flags (e.g., `+faststart`, `+frag_keyframe`)
  - Default behavior: For ISO BMFF outputs (MP4/fMP4, including HLS with fMP4), the tool enables `+delay_moov` by default alongside other flags (e.g., `+faststart`, `+default_base_moof`, `+write_colr`). Delaying the moov atom improves compatibility with codecs like EAC3 that require packet analysis before header writing.
- **`-frag_duration <microseconds>`**: Fragment duration for fragmented MP4
- **`-fragment_index <num>`**: Fragment index
- **`-use_editlist <0|1>`**: Use MP4 edit lists
- **`-max_muxing_queue_size <packets>`**: Maximum muxing queue size
- **`-max_delay <microseconds>`**: Maximum muxing delay

## Notes on Default Configuration

- **VSR / scaling**
  - Enabled by default with 2√ó scaling and quality level 4
  - **Auto-disables** for inputs ‚â•1440p
  - Can be manually disabled with `--no-vsr`

- **TrueHDR**
  - Enabled by default with `{contrast=115, saturation=75, middleGray=30, maxLuminance=1000}`
  - **Auto-disables** for HDR inputs (PQ/HDR10 or HLG) to preserve original HDR metadata
  - Disabling TrueHDR switches the pipeline to BT.709 SDR signaling
  - Can be manually disabled with `--no-thdr`

- **NVENC**
  - Uses Main10 profile, constant QP 21, preset `p7`, tune `hq`
  - GOP length: `3 √ó fps` frames
  - B-frames: 2 (default)
  - Bitrate: `input_bitrate √ó 5` (fallback: 25 Mbps if unknown)
  - Hardware pool: 64-frame surfaces

- **Color metadata**
  - TrueHDR active: BT.2020/PQ mastering data in stream and container
  - SDR output: BT.709 primaries and transfer characteristics

- **Audio/subtitles**
  - **Default**: All non-video streams copied verbatim without transcoding
  - In FFmpeg-compatible mode with `-map`: Only explicitly mapped streams included
  - Use `-codec:a copy` for audio passthrough, or specify codec for transcoding

- **Supported formats**
  - **Input**: MP4, MKV, HLS (`.m3u8`), network streams (HTTP/HTTPS/RTMP/RTSP/TCP/UDP), pipe
  - **Output**: MP4, MKV, HLS (`.m3u8`), fragmented MP4, pipe
  - **Unsupported operations**: Automatically passed through to system FFmpeg when binary is named `ffmpeg.exe`

## Usage

### Simple Mode
```
RTXVideoProcessor.exe <input> <output> [options]
```

### FFmpeg-Compatible Mode
```
RTXVideoProcessor.exe -i <input> [options] <output>
```

## Examples

### Simple Mode Examples

```bash
# Basic: Apply RTX VSR + TrueHDR with defaults
RTXVideoProcessor.exe input.mp4 output_hdr.mp4

# Disable VSR, keep TrueHDR only
RTXVideoProcessor.exe input.mp4 output.mp4 --no-vsr

# SDR output (disable both RTX features)
RTXVideoProcessor.exe input.mp4 output_sdr.mp4 --no-vsr --no-thdr

# Custom NVENC settings
RTXVideoProcessor.exe input.mp4 output.mp4 --nvenc-rc vbr --nvenc-bitrate-multiplier 3 --nvenc-preset p4

# CPU processing path (no GPU)
RTXVideoProcessor.exe input.mp4 output.mp4 --cpu --no-vsr
```

### FFmpeg-Compatible Mode Examples

```bash
# Basic FFmpeg syntax with RTX processing
RTXVideoProcessor.exe -i input.mp4 output.mp4

# Stream mapping: video + audio only, exclude subtitles
RTXVideoProcessor.exe -i input.mkv -map 0:0 -map 0:1 -map -0:s output.mp4

# Audio passthrough (copy without re-encoding)
RTXVideoProcessor.exe -i input.mp4 -codec:a copy output.mp4

# Audio transcoding with specific codec
RTXVideoProcessor.exe -i input.mp4 -codec:a aac -ab 192000 -ac 2 output.mp4

# Seeking: Extract 30 seconds starting from 1 minute
RTXVideoProcessor.exe -i input.mp4 -ss 00:01:00 -t 30 output.mp4

# Preserve original timestamps
RTXVideoProcessor.exe -i input.mp4 -copyts -avoid_negative_ts disabled output.mp4

# Force constant frame rate (fix VFR issues)
RTXVideoProcessor.exe -i input.mp4 -vsync cfr output.mp4

# HLS streaming output (fMP4 segments)
RTXVideoProcessor.exe -i input.mp4 -format hls -hls_time 6 \
  -hls_segment_type fmp4 -hls_fmp4_init_filename init.mp4 output.m3u8

# HLS with stream mapping and audio copy
RTXVideoProcessor.exe -i input.mkv -map 0:0 -map 0:1 -codec:a copy \
  -format hls -hls_segment_type fmp4 -hls_fmp4_init_filename init.mp4 output.m3u8

# Network stream input to local file
RTXVideoProcessor.exe -i http://example.com/stream.m3u8 output.mp4

# Pipe output to another process
RTXVideoProcessor.exe -i input.mp4 -f mp4 pipe:1 | ffmpeg -i pipe:0 -c copy final.mp4

# Fragmented MP4 for streaming
RTXVideoProcessor.exe -i input.mp4 -movflags +frag_keyframe+empty_moov+default_base_moof output.mp4

# Disable RTX in FFmpeg mode
RTXVideoProcessor.exe -i input.mp4 --no-vsr --no-thdr output.mp4
```

### Drop-in FFmpeg Replacement

```bash
# Rename binary to ffmpeg.exe
copy RTXVideoProcessor.exe ffmpeg.exe

# Now use as drop-in replacement - supported operations get RTX processing
ffmpeg.exe -i input.mp4 -codec:a copy output.mp4          # RTX processing + audio copy

# Unsupported operations automatically pass through to real FFmpeg
ffmpeg.exe -i input.wav -codec:a libmp3lame output.mp3    # Passthrough (audio-only)
ffmpeg.exe -i input.avi output.mov                        # Passthrough (unsupported formats)
```


## Prerequisites

### For Building from Source
- **Windows 11 x64** with an NVIDIA RTX 4070 (or newer recommended)
- **CUDA Toolkit 12.8** installed and on the PATH
- **NVIDIA RTX Video SDK** headers and libraries, with `NV_RTX_VIDEO_SDK` environment variable pointing to the SDK root
- **NVIDIA Video Codec SDK** (NVENC/NVDEC) with `NV_VIDEO_CODEC_SDK` environment variable pointing to the SDK root
- **FFmpeg** (for dynamic builds): prebuilts at `C:\ffmpeg` providing `include/`, `lib/`, and `bin/`
- **vcpkg** (for static builds): integrated with Visual Studio or standalone
- **NVIDIA driver** 546.01 or newer (required for RTX Video SDK features and HDR support)

### For Running Pre-built Binaries
- **Windows 11 x64**
- **NVIDIA RTX 40-series GPU** (or newer) with driver 546.01+
- **NVIDIA RTX Video SDK runtime DLLs** (see [Runtime Dependencies](#runtime-dependencies) below)

## Runtime Dependencies

RTXVideoProcessor requires the following NVIDIA proprietary DLLs to run:

- `nvngx_vsr.dll` - RTX Video Super Resolution runtime
- `nvngx_truehdr.dll` - RTX TrueHDR runtime

### How to Obtain NVIDIA DLLs

‚ö†Ô∏è **These DLLs are proprietary NVIDIA software and cannot be redistributed with this project.**

To obtain the required DLLs:

1. **Download the NVIDIA RTX Video SDK** from the official NVIDIA Developer portal:
   - Visit: https://developer.nvidia.com/rtx-video-sdk
   - Register/sign in with an NVIDIA Developer account (free)
   - Download the SDK package for Windows

2. **Extract the DLLs** from the SDK package:
   - After extraction, navigate to: `RTX_Video_SDK/bin/Windows/x64/rel/`
   - Locate `nvngx_vsr.dll` and `nvngx_truehdr.dll`

3. **Place the DLLs** in the same directory as `RTXVideoProcessor.exe`:
   ```
   RTXVideoProcessor.exe
   nvngx_vsr.dll          ‚Üê Copy from SDK
   nvngx_truehdr.dll      ‚Üê Copy from SDK
   ```

**Note**: Pre-built releases include the main executable but **NOT** the NVIDIA DLLs. You must obtain these separately from NVIDIA as described above.

## Build

### Dynamic Build (Requires FFmpeg DLLs at Runtime)
```bash
cmake -S . -B build -G "Visual Studio 17 2022" -A x64 -DFFMPEG_ROOT=C:/ffmpeg
cmake --build build --config Release -j
```

The resulting binary will be at `build/Release/RTXVideoProcessor.exe`. You'll need to ensure FFmpeg DLLs are accessible:
```bash
# Option 1: Copy FFmpeg DLLs to the executable directory
copy C:\ffmpeg\bin\*.dll build\Release\

# Option 2: Add C:\ffmpeg\bin to your system PATH
```

### Static Build (Standalone Executable, No FFmpeg DLLs Required)
```bash
# Configure with vcpkg for static FFmpeg libraries
cmake -B build-static ^
  -DUSE_STATIC_FFMPEG=ON ^
  -DCMAKE_TOOLCHAIN_FILE="C:/Program Files/Microsoft Visual Studio/2022/Community/VC/vcpkg/scripts/buildsystems/vcpkg.cmake" ^
  -DVCPKG_TARGET_TRIPLET=x64-windows-static

# Build
cmake --build build-static --config Release -j
```

The resulting binary will be at `build-static/Release/RTXVideoProcessor.exe` (~21 MB).

**Static builds are self-contained** and don't require FFmpeg DLLs, but still need the NVIDIA RTX Video SDK DLLs (`nvngx_vsr.dll` and `nvngx_truehdr.dll`) as described in [Runtime Dependencies](#runtime-dependencies).

## Troubleshooting
- **CUDA negotiation** If CUDA initialization fails, verify the GPU driver, confirm the Video Codec SDK DLLs are present, and try `--cpu` to validate the rest of the pipeline.
- **HDR validation** When TrueHDR is enabled, ensure your playback tool honors the inserted mastering metadata; fall back to `--no-thdr` for SDR deliveries.
- **Bitrate control** Tune `--nvenc-rc`, `--nvenc-qp`, or `--nvenc-bitrate-multiplier` to meet delivery requirements.

## TODO
- Resolve stutters at specific presets
- Add support for 1440p inputs
- Refine code quality
- Add support for more input/output formats
- Add tests, so as to not break functionality
- Work on documentation
- Prepare for release
- Investigate Stremio seek desync bug


## Contributing
I welcome any contributions to this project. Any feedback, bug reports, or feature requests are greatly appreciated. Please open an issue or submit a pull request.

## License & Redistribution

### Project License
This project's source code is released under the **MIT License** (see [LICENSE](LICENSE) file).

You are free to use, modify, and distribute the source code according to the terms of the MIT License.

### Third-Party Components & Redistribution Notice

‚ö†Ô∏è **Important**: This project uses proprietary NVIDIA components that have separate licensing terms.

#### NVIDIA RTX Video SDK Components

This project uses the NVIDIA RTX Video SDK (NGX runtime) for RTX Video Super Resolution and TrueHDR features. The following NVIDIA components are **proprietary software owned by NVIDIA Corporation**:

- `nvngx_vsr.dll` - NVIDIA RTX Video Super Resolution
- `nvngx_truehdr.dll` - NVIDIA RTX TrueHDR

**Redistribution Restrictions**:
- These DLLs are **NOT included** in this repository or in binary releases
- These DLLs **CANNOT be redistributed** without NVIDIA's explicit permission
- Users must obtain these components directly from NVIDIA via the [RTX Video SDK](https://developer.nvidia.com/rtx-video-sdk)
- These components are subject to the NVIDIA RTX Video SDK End User License Agreement

**For Commercial Use**: If you plan to distribute this software commercially with the NVIDIA RTX Video SDK components, you must:
1. Contact NVIDIA via their SW-notification process
2. Obtain appropriate licensing/permission from NVIDIA
3. Comply with NVIDIA's redistribution requirements

#### Other Dependencies

- **FFmpeg**: This project uses FFmpeg libraries (LGPL 2.1+ or GPL 2+ depending on build configuration)
  - Static builds include FFmpeg code statically linked (LGPL 2.1 compliance requires providing source code and build instructions)
  - Dynamic builds link to FFmpeg DLLs at runtime (no redistribution concerns)
  - FFmpeg source code and licensing: https://ffmpeg.org/legal.html

- **NVIDIA Video Codec SDK**: Hardware video encode/decode interface (subject to NVIDIA Video Codec SDK license)
- **CUDA**: CUDA runtime libraries (subject to NVIDIA CUDA EULA)

### Summary

**What you can do**:
- Use this project's source code under the MIT License
- Build and use the software for personal or commercial purposes
- Modify and distribute the source code

**What you cannot do** (without NVIDIA's permission):
- Redistribute NVIDIA's proprietary DLLs (`nvngx_vsr.dll`, `nvngx_truehdr.dll`)
- Include NVIDIA SDK binaries in derivative works or binary releases
- Distribute commercial products with embedded NVIDIA RTX components without NVIDIA approval

**Disclaimer**: This project is provided "as-is" without warranty of any kind. The author is not responsible for any third-party licensing requirements. Users are responsible for ensuring compliance with all applicable licenses, including NVIDIA's SDK licenses.


