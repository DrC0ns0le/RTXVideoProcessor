# RTXVideoProcessor

This CLI tool allows you to take any H.264/H.265 MP4/MKV file, and using the NVIDIA RTX Video SDK, apply Video Super Resoltion(VSR) and TrueHDR (SDR to HDR) processing to the video, and output a Main10 HEVC file with the processed video. Refer to NVIDIA RTX Video SDK documentation for more information. [RTX Video SDK](https://developer.nvidia.com/rtx-video-sdk)

The pipeline processes the video on the GPU for zero-copy processing. All audio/subtitles are copied verbatim without transcoding. Based on my experience, at p7 preset, my RTX 4070 processes the video at around ~2x real-time speed for a 1080p input, and ~3-5x real-time speed for p4 preset. However, I noticed that at p4 preset, there seems to be occasional stutters in the output video. Any help with this would be greatly appreciated.

Word of caution: This is my first attempt at a C++ project. I am not a professional developer and I am not a C++ developer. This project is as much of a learning experience for me as it is a tool for me. I have never touched C++, CUDA or system programming prior to this project. Majority of the code is generated by AI tools, however, I have --- to my best of knowledge and ability --- attempted to understand and refine the code, ensuring it is as close to production-ready as possible. 

## Runtime modes
- **GPU path (default)** Requires NVDEC/NVENC. Color conversion, RTX evaluation, and packing run on the CUDA context supplied by FFmpeg. 
- **CPU path (`--cpu`)** Forces software color conversion and host-side RTX processing while NVENC still produces Main10 output from CPU-backed P010 frames.


## Command-line options
- **`-v`, `--verbose`**: Enable verbose logging through `Logger` (`src/logger.*`).
- **`--cpu`**: Force the CPU processing path.
- **`--no-vsr`**: Disable RTX VSR upscaling.
- **`--vsr-quality <1-4>`**: Select the VSR quality level (default 4).
- **`--no-thdr`**: Disable RTX TrueHDR tone mapping.
- **`--thdr-contrast <int>`**: Override TrueHDR contrast (default 115).
- **`--thdr-saturation <int>`**: Override TrueHDR saturation (default 75).
- **`--thdr-middle-gray <int>`**: Override TrueHDR middle gray (default 30).
- **`--thdr-max-luminance <int>`**: Override TrueHDR peak luminance in nits (default 1000).
- **`--nvenc-tune <string>`**: Set the NVENC tune (default `hq`).
- **`--nvenc-preset <string>`**: Set the NVENC preset (default `p7`).
- **`--nvenc-rc <string>`**: Select the NVENC rate control mode (default `constqp`).
- **`--nvenc-gop <int>`**: Set the GOP length in seconds expressed as `gop * fps` (default 1).
- **`--nvenc-bframes <int>`**: Set the maximum B-frame count (default 2).
- **`--nvenc-qp <int>`**: Set the constant QP (default 21 when `constqp` is active).
- **`--nvenc-bitrate-multiplier <int>`**: Multiply the detected input bitrate to derive the target bitrate (default 5×). The fallback target is 25 Mbps when the input bitrate is unknown.

## Notes on default configuration
- **VSR / scaling** VSR is enabled by default with 2× scaling and quality level 4. Inputs at or above 1080p bypass VSR automatically.
- **TrueHDR** Enabled by default with `{contrast=115, saturation=75, middleGray=30, maxLuminance=1000}`. Disabling TrueHDR switches the pipeline to BT.709 signaling.
- **NVENC** Uses Main10, constant QP 21, preset `p7`, tune `hq`, GOP `gop * fps`, and applies the bitrate multiplier to `in.fmt->bit_rate`. Encoder surfaces are drawn from a 64-frame hardware pool.
- **Color metadata** When TrueHDR is active, both stream and container metadata carry BT.2020/PQ mastering data. SDR output keeps BT.709 primaries and transfer characteristics.
- **Audio/subtitles** All non-video streams are remuxed verbatim without transcoding.

## Usage
```
RTXVideoProcessor.exe input.[mp4|mkv] output.[mp4|mkv] [options]
```

## Examples
```
# Full GPU pipeline with defaults
RTXVideoProcessor.exe input.mp4 output_hdr.mp4

# CPU processing path without VSR but with custom NVENC settings
RTXVideoProcessor.exe input.mp4 output_sdr.mkv --cpu --no-vsr --nvenc-rc vbr --nvenc-bitrate-multiplier 3
```


## Prerequisites
- **Windows 11 x64** with an NVIDIA RTX 4070 (or newer recommended).
- **CUDA Toolkit 12.8** installed and on the PATH.
- **NVIDIA RTX Video SDK** headers and libraries, with `NV_RTX_VIDEO_SDK` pointing to the SDK root.
- **NVIDIA Video Codec SDK** (NVENC/NVDEC) with `NV_VIDEO_CODEC_SDK` pointing to the SDK root.
- **FFmpeg** prebuilts at `C:\ffmpeg` providing `include/`, `lib/`, and `bin/`. Ensure DLLs are accessible at runtime.
- **NVIDIA driver** recent enough to expose RTX Video SDK features and HDR-capable CUDA 10:10:10:2 arrays.

## Build
```
cmake -S . -B build -G "Visual Studio 17 2022" -A x64
cmake --build build --config Release -j
```
The resulting binary will be at `build/Release/RTXVideoProcessor.exe`. Copy FFmpeg runtime DLLs next to the executable if they are not on your PATH:
```
copy C:\ffmpeg\bin\*.dll build\Release\
```

## Troubleshooting
- **CUDA negotiation** If CUDA initialization fails, verify the GPU driver, confirm the Video Codec SDK DLLs are present, and try `--cpu` to validate the rest of the pipeline.
- **HDR validation** When TrueHDR is enabled, ensure your playback tool honors the inserted mastering metadata; fall back to `--no-thdr` for SDR deliveries.
- **Bitrate control** Tune `--nvenc-rc`, `--nvenc-qp`, or `--nvenc-bitrate-multiplier` to meet delivery requirements.

## TODO
- Resolve stutters at specific presets
- Add support for 1440p inputs
- Refine code quality
- Add support for more input/output formats

## Contributing
I welcome any contributions to this project. Any feedback, bug reports, or feature requests are greatly appreciated. Please open an issue or submit a pull request.

## License
TBC


